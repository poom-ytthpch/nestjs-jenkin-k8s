pipeline {

  agent {
    kubernetes {
      yaml """
apiVersion: v1
kind: Pod
spec:
  containers:

  - name: node
    image: node:20-alpine
    command:
    - cat
    tty: true

  - name: docker
    image: docker:26-cli
    command:
    - cat
    tty: true
    volumeMounts:
      - name: docker-sock
        mountPath: /var/run/docker.sock

  volumes:
  - name: docker-sock
    hostPath:
      path: /var/run/docker.sock
"""
    }
  }

  environment {
    DOCKER_IMAGE = 'ytthpch/nestjs-jenkin-k8s'
    DOCKER_TAG   = '1.5'

    K8S_NAMESPACE = 'default'
    K8S_DEPLOYMENT_NAME = 'nestjs-jenkin-k8s-app'
  }

  stages {

    // ---------------------------
    stage('Checkout') {
      steps {
        container('node') {
          git branch: 'main',
              url: 'https://github.com/poom-ytthpch/nestjs-jenkin-k8s.git'
        }
      }
    }

    // ---------------------------
    stage('Install & Build') {
      steps {
        container('node') {
          sh '''
            node -v
            npm -v

            echo "=== Installing dependencies ==="
            npm install

            echo "=== Building application ==="
            npm run build
          '''
        }
      }
    }

    // ---------------------------
    stage('Build & Push Image') {

      steps {

        container('docker') {

          withCredentials([
            usernamePassword(
              credentialsId: 'docker-hub-credentials',
              usernameVariable: 'DOCKER_USER',
              passwordVariable: 'DOCKER_PASS'
            )
          ]) {

            sh '''
              echo "=== Docker Build ==="
              docker build -t ${DOCKER_IMAGE}:${DOCKER_TAG} .

              echo "=== Docker Login ==="
              echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin

              echo "=== Docker Push ==="
              docker push ${DOCKER_IMAGE}:${DOCKER_TAG}
            '''
          }
        }
      }
    }

    // ---------------------------
    stage('Kubernetes Deploy') {

      steps {

        container('node') {

          withCredentials([
            string(credentialsId: 'nestjs-jenkin-k8s-env', variable: 'ENV_FILE'),
            file(credentialsId: 'k8s-config', variable: 'KUBECONFIG')
          ]) {

            sh '''
              echo "=== Install kubectl ==="
              curl -LO https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl
              chmod +x kubectl
              mv kubectl /usr/local/bin/

              export KUBECONFIG=$KUBECONFIG

              echo "=== Create .env ==="
              echo "$ENV_FILE" > .env

              kubectl delete configmap nestjs-jenkin-k8s-env \
                -n ${K8S_NAMESPACE} \
                --ignore-not-found

              kubectl create configmap nestjs-jenkin-k8s-env \
                --from-env-file=.env \
                -n ${K8S_NAMESPACE}

              sed -i "s|image: .*|image: ${DOCKER_IMAGE}:${DOCKER_TAG}|g" k8s/deployment.yaml

              kubectl apply -f k8s/deployment.yaml -n ${K8S_NAMESPACE}
              kubectl apply -f k8s/service.yaml -n ${K8S_NAMESPACE}

              kubectl rollout status deployment/${K8S_DEPLOYMENT_NAME} \
                -n ${K8S_NAMESPACE}
            '''
          }
        }
      }
    }
  }

  post {
    success {
      echo 'Deployment successful!'
    }

    failure {
      echo 'Deployment failed!'
    }
  }
}