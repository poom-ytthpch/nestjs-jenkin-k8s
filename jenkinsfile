pipeline {

  agent {
    kubernetes {
      yaml """
apiVersion: v1
kind: Pod
spec:
  containers:

  - name: node
    image: node:20
    command:
    - cat
    tty: true
    volumeMounts:
    - name: workspace
      mountPath: /home/jenkins/agent

  - name: docker
    image: docker:24-dind
    command:
    - cat
    tty: true
    volumeMounts:
    - name: workspace
      mountPath: /home/jenkins/agent
    - name: docker-socket
      mountPath: /var/run/docker.sock

  - name: kubectl
    image: bitnami/kubectl:latest
    command:
    - cat
    tty: true
    volumeMounts:
    - name: workspace
      mountPath: /home/jenkins/agent

  volumes:
  - name: workspace
    emptyDir: {}
  - name: docker-socket
    hostPath:
      path: /var/run/docker.sock
"""
    }
  }

  environment {
    DOCKER_IMAGE = 'ytthpch/nestjs-jenkin-k8s'
    DOCKER_TAG   = '1.4'

    K8S_NAMESPACE = 'default'
    K8S_DEPLOYMENT_NAME = 'nestjs-jenkin-k8s-app'
  }

  stages {

    // ---------------------------
    stage('Checkout') {
      steps {
        git branch: 'main',
            url: 'https://github.com/poom-ytthpch/nestjs-jenkin-k8s.git'
      }
    }

    // ---------------------------
    stage('Install & Build') {
      steps {
        container('node') {
          sh '''
            npm install
            npm run build
          '''
        }
      }
    }

    // ---------------------------
    stage('Build & Push Image (Docker)') {

      steps {

        container('docker') {

          withCredentials([
            usernamePassword(
              credentialsId: 'docker-hub-credentials',
              usernameVariable: 'DOCKER_USER',
              passwordVariable: 'DOCKER_PASS'
            )
          ]) {

            sh '''
              echo "=== Building Docker image ==="
              docker build -t ${DOCKER_IMAGE}:${DOCKER_TAG} .

              echo "=== Logging into Docker Hub ==="
              echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin

              echo "=== Pushing Docker image ==="
              docker push ${DOCKER_IMAGE}:${DOCKER_TAG}

              echo "=== Docker push completed ==="
            '''
          }
        }
      }
    }

    // ---------------------------
    stage('Kubernetes Deploy') {

      steps {

        container('kubectl') {

          withCredentials([
            string(credentialsId: 'nestjs-jenkin-k8s-env', variable: 'ENV_FILE'),
            file(credentialsId: 'k8s-config', variable: 'KUBECONFIG')
          ]) {

            sh '''
              echo "=== Echo .env file from nestjs-jenkin-k8s-env secret ==="
              echo "$ENV_FILE"
              echo ""

              echo "=== Creating .env file ==="
              echo "$ENV_FILE" > .env
              cat .env
              echo ""

              export KUBECONFIG=$KUBECONFIG

              echo "=== Deleting existing configmap ==="
              kubectl delete configmap nestjs-jenkin-k8s-env \
                -n ${K8S_NAMESPACE} \
                --ignore-not-found

              echo "=== Creating new configmap from .env file ==="
              kubectl create configmap nestjs-jenkin-k8s-env \
                --from-env-file=.env \
                -n ${K8S_NAMESPACE}

              echo "=== Updating deployment image ==="
              sed -i "s|image: .*|image: ${DOCKER_IMAGE}:${DOCKER_TAG}|g" k8s/deployment.yaml

              echo "=== Applying Kubernetes manifests ==="
              kubectl apply -f k8s/deployment.yaml -n ${K8S_NAMESPACE}
              kubectl apply -f k8s/service.yaml -n ${K8S_NAMESPACE}

              echo "=== Waiting for deployment rollout ==="
              kubectl rollout status deployment/${K8S_DEPLOYMENT_NAME} \
                -n ${K8S_NAMESPACE}

              echo "=== Deployment completed successfully ==="
            '''
          }
        }
      }
    }
  }

  post {
    success {
      echo 'Deployment successful!'
    }

    failure {
      echo 'Deployment failed!'
    }
  }
}