pipeline {

  agent {
    kubernetes {
      yaml """
apiVersion: v1
kind: Pod
spec:
  containers:

  - name: node
    image: node:20
    command:
    - cat
    tty: true

  - name: kaniko
    image: gcr.io/kaniko-project/executor:latest
    args:
    - --sleep
    - "999999"
    volumeMounts:

  - name: docker-config
    mountPath: /kaniko/.docke

  - name: kubectl
    image: bitnami/kubectl:latest
    command:
    - cat
    tty: true

  volumes:
  - name: docker-config
    emptyDir: {}
"""
    }
  }

  environment {
    DOCKER_IMAGE = 'ytthpch/nestjs-jenkin-k8s'
    DOCKER_TAG   = '1.4'

    K8S_NAMESPACE = 'default'
    K8S_DEPLOYMENT_NAME = 'nestjs-jenkin-k8s-app'
  }

  stages {

    // ---------------------------
    stage('Checkout') {
      steps {
        git branch: 'main',
            url: 'https://github.com/poom-ytthpch/nestjs-jenkin-k8s.git'
      }
    }

    // ---------------------------
    stage('Install & Build') {
      steps {
        container('node') {
          sh '''
            npm install
            npm run build
          '''
        }
      }
    }

    // ---------------------------
    stage('Build & Push Image (Kaniko)') {

      steps {

        container('kaniko') {

          withCredentials([
            usernamePassword(
              credentialsId: 'docker-hub-credentials',
              usernameVariable: 'DOCKER_USER',
              passwordVariable: 'DOCKER_PASS'
            )
          ]) {

            sh '''
              mkdir -p /kaniko/.docker

              cat <<EOF > /kaniko/.docker/config.json
              {
                "auths": {
                  "https://index.docker.io/v1/": {
                    "username": "$DOCKER_USER",
                    "password": "$DOCKER_PASS"
                  }
                }
              }
              EOF

              /kaniko/executor \
                --context=${WORKSPACE} \
                --dockerfile=${WORKSPACE}/Dockerfile \
                --destination=${DOCKER_IMAGE}:${DOCKER_TAG}
            '''
          }
        }
      }
    }

    // ---------------------------
    stage('Create ConfigMap') {

      steps {

        container('kubectl') {

          withCredentials([
            string(credentialsId: 'nestjs-jenkin-k8s-env', variable: 'ENV_FILE'),
            file(credentialsId: 'k8s-config', variable: 'KUBECONFIG')
          ]) {

            sh '''
              echo "$ENV_FILE" > .env

              export KUBECONFIG=$KUBECONFIG

              kubectl delete configmap nestjs-jenkin-k8s-env \
                -n ${K8S_NAMESPACE} \
                --ignore-not-found

              kubectl create configmap nestjs-jenkin-k8s-env \
                --from-env-file=.env \
                -n ${K8S_NAMESPACE}
            '''
          }
        }
      }
    }

    // ---------------------------
    stage('Deploy') {

      steps {

        container('kubectl') {

          withCredentials([
            file(credentialsId: 'k8s-config', variable: 'KUBECONFIG')
          ]) {

            sh '''
              export KUBECONFIG=$KUBECONFIG

              sed -i "s|image: .*|image: ${DOCKER_IMAGE}:${DOCKER_TAG}|g" k8s/deployment.yaml

              kubectl apply -f k8s/deployment.yaml -n ${K8S_NAMESPACE}
              kubectl apply -f k8s/service.yaml -n ${K8S_NAMESPACE}

              kubectl rollout status deployment/${K8S_DEPLOYMENT_NAME} \
                -n ${K8S_NAMESPACE}
            '''
          }
        }
      }
    }
  }

  post {
    success {
      echo 'Deployment successful!'
    }

    failure {
      echo 'Deployment failed!'
    }
  }
}